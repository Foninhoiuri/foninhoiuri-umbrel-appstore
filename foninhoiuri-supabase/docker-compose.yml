version: '3.8'

services:
  auth:
    image: supabase/gotrue:v2.176.1
    restart: unless-stopped
    networks:
      - umbrel-external
    environment:
      DB_URL: postgresql://default:default@postgresql:5432/supabase
      JWT_SECRET: ${JWT_SECRET}
      SITE_URL: http://kong:8000/auth/v1
      DISABLE_SIGNUP: "false"

  storage:
    image: supabase/storage-api:latest
    restart: unless-stopped
    networks:
      - umbrel-external
    environment:
      DB_URL: postgresql://default:default@postgresql:5432/supabase
      JWT_SECRET: ${JWT_SECRET}
      STORAGE_BACKEND: s3
      GLOBAL_S3_BUCKET: your-supabase-bucket
      STORAGE_S3_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ${APP_DATA_DIR}/data/supabase-storage:/var/log/supabase/storage

  rest:
    image: postgrest/postgrest:latest
    restart: unless-stopped
    networks:
      - umbrel-external
    environment:
      PGRST_DB_URI: postgresql://default:default@postgresql:5432/supabase
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_SCHEMA: public,storage,auth,extensions
      PGRST_DB_ANON_ROLE: anon

  realtime:
    image: supabase/realtime:latest
    restart: unless-stopped
    networks:
      - umbrel-external
    environment:
      DB_URL: postgresql://default:default@postgresql:5432/supabase
      JWT_SECRET: ${JWT_SECRET}
      REDIS_URL: redis://redis:6379

  studio:
    image: supabase/studio:latest
    restart: unless-stopped
    networks:
      - umbrel-external
    environment:
      SUPABASE_URL: http://kong:8000
      SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SERVICE_ROLE_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

volumes:
  supabase-storage:

networks:
  umbrel-external:
    external: true
