version: '3.7'

services:
  # ----------------------------------------------------
  # 1. Serviço Web Principal (Chatwoot Server)
  # ----------------------------------------------------
  web:
    image: chatwoot/chatwoot:v3.10.0 # Utilize a versão estável mais recente
    restart: unless-stopped
    depends_on:
      - worker # O worker não é uma dependência estrita, mas é boa prática ter ambos.
    command: ['bundle', 'exec', 'rails', 's', '-p', '3000', '-b', '0.0.0.0']
    ports:
      - 3000:3000 # Porta interna que o Umbrel usará para o proxy
    volumes:
      - chatwoot_storage:/app/storage # Volume para armazenamento de arquivos
    environment:
      # Variáveis de Ambiente Essenciais para Produção
      - RAILS_ENV=production
      - NODE_ENV=production
      - INSTALLATION_ENV=docker
      - FRONTEND_URL=http://chatwoot.local:3000 
      - FORCE_SSL=false 
      
      # Variável Secreta (Chave de Segurança)
      - SECRET_KEY_BASE=$APP_SECRET_CHATWOOT_SECRET_KEY_BASE
      
      # Configuração do Banco de Dados (USANDO VARIÁVEIS DE DEPENDÊNCIA DO UMBREL)
      # Assume que o Umbrel injeta as variáveis POSTGRES_IP e POSTGRES_PORT
      - POSTGRES_HOST=$POSTGRESQL_HOST
      - POSTGRES_PORT=$POSTGRESQL_PORT
      - POSTGRES_USERNAME=$POSTGRESQL_USERNAME
      - POSTGRES_PASSWORD=$POSTGRESQL_PASSWORD
      # Você deve usar o mesmo banco de dados (database name) que outros apps não estão usando.
      - POSTGRES_DATABASE=chatwoot
      
      # Configuração do Redis (USANDO VARIÁVEIS DE DEPENDÊNCIA DO UMBREL)
      # Assume que o Umbrel injeta as variáveis REDIS_HOST e REDIS_PORT
      - REDIS_URL=redis://$REDIS_HOST:$REDIS_PORT/1
      
      # Configuração de Email (Recomendado)
      # - MAILER_SENDER_EMAIL=chatwoot@$UMBREL_WEB_DOMAIN
      # - SMTP_ADDRESS=
      # ...
      
  # ----------------------------------------------------
  # 2. Serviço Worker (Sidekiq para tarefas em segundo plano)
  # ----------------------------------------------------
  worker:
    image: chatwoot/chatwoot:v3.10.0
    restart: unless-stopped
    volumes:
      - chatwoot_storage:/app/storage
    environment:
      - RAILS_ENV=production
      - NODE_ENV=production
      - INSTALLATION_ENV=docker
      - SECRET_KEY_BASE=$APP_SECRET_CHATWOOT_SECRET_KEY_BASE
      
      # Configuração do Banco de Dados
      - POSTGRES_HOST=$POSTGRESQL_HOST
      - POSTGRES_PORT=$POSTGRESQL_PORT
      - POSTGRES_USERNAME=$POSTGRESQL_USERNAME
      - POSTGRES_PASSWORD=$POSTGRESQL_PASSWORD
      - POSTGRES_DATABASE=chatwoot

      # Configuração do Redis
      - REDIS_URL=redis://$REDIS_HOST:$REDIS_PORT/1

# ----------------------------------------------------
# Definição de Volumes para Persistência de Dados
# ----------------------------------------------------
volumes:
  chatwoot_storage:
